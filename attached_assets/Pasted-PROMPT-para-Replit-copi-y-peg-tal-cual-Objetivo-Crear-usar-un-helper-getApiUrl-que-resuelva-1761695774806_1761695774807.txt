PROMPT para Replit (copiá y pegá tal cual)

Objetivo:

Crear/usar un helper getApiUrl() que resuelva la base de la API (usa import.meta.env.VITE_API_BASE si existe, si no, usa relativo).

Actualizar PaymentMethodModal.tsx para que el botón “Continuar”:

Llame a POST ${getApiUrl()}/api/mp/create-preference con Content-Type: application/json.

En éxito, redirija con window.location.assign(init_point).

En error, muestre el error y libere loading en finally.

1) Crear helper para URLs

Crea el archivo src/lib/apiUrl.ts (si no existe) con este contenido:

// src/lib/apiUrl.ts
export function getApiUrl() {
  // En producción Vercel: setear VITE_API_BASE = https://tudominio.vercel.app
  // En Preview de Replit: dejar vacío y usará rutas relativas (/api/...)
  const base = (import.meta as any)?.env?.VITE_API_BASE?.trim?.() || "";
  return base.replace(/\/$/, ""); // sin trailing slash
}

2) Parchear el modal de pagos

Abrí src/components/modals/PaymentMethodModal.tsx (o la ruta exacta donde está tu modal) y reemplazá el handler de “Continuar” por esta versión sólida. Si no existe un handler único, crealo y conectalo al botón.

// en lo alto del archivo
import { useState } from "react";
import { getApiUrl } from "@/lib/apiUrl";

type Provider = "mercadopago" | "paypal" | "transferencia";

// ... resto de imports del modal

export default function PaymentMethodModal(props: any) {
  const { userId, courseSlug, onClose } = props; // ajustá si tus props se llaman distinto
  const [selected, setSelected] = useState<Provider>("mercadopago");
  const [loading, setLoading] = useState(false);

  async function handleContinue() {
    setLoading(true);
    const api = getApiUrl();

    try {
      if (selected === "mercadopago") {
        console.log("[MP] creando preferencia…", { userId, courseSlug });

        const res = await fetch(`${api}/api/mp/create-preference`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            user_id: userId,
            course_slug: courseSlug,
            currency: "ARS",    // si tenés selector de moneda, reemplazá
            months: null        // si usás meses, enviá el valor aquí (1, 3, 6, 12…)
          }),
        });

        const data = await res.json().catch(() => ({} as any));
        console.log("[MP] respuesta create-preference:", { status: res.status, data });

        if (!res.ok || !data?.init_point) {
          // Mostramos detalle para depurar rápido
          throw new Error(
            `create-preference falló: status=${res.status} body=${JSON.stringify(data)}`
          );
        }

        // Redirigir a Mercado Pago
        window.location.assign(String(data.init_point));
        return; // importante
      }

      if (selected === "paypal") {
        // tu flujo paypal actual (ya dijiste que funciona)
        // por ejemplo: await startPaypalFlow();
        return;
      }

      if (selected === "transferencia") {
        // tu flujo (mostrar instrucciones, etc.)
        return;
      }
    } catch (e: any) {
      console.error("Error en handleContinue:", e);
      alert(e?.message ?? "No se pudo iniciar el pago. Probá nuevamente.");
    } finally {
      setLoading(false); // nunca dejes el spinner colgado
    }
  }

  return (
    <div>
      {/* … el contenido de tu modal … */}
      {/* Asegurate de setear `selected` al elegir el método */}
      {/* Ej: onChange={() => setSelected("mercadopago")} en el radio de MP */}

      <button
        onClick={handleContinue}
        disabled={loading}
        className="btn btn-primary"
      >
        {loading ? "Cargando…" : "Continuar"}
      </button>
    </div>
  );
}


Puntos críticos del parche:

getApiUrl() permite que en Replit Preview se use /api/... y en Vercel use https://sukanec.vercel.app/api/... (porque le pasaste VITE_API_BASE).

Usamos await res.json() y validamos res.ok && data.init_point.

Siempre liberamos loading en finally.

Hacemos window.location.assign(init_point) para redirigir de verdad.

3) Checklist de verificación rápida

Network tab al clickear “Continuar”:

Debe verse un POST /api/mp/create-preference (o absoluto a Vercel si estás en producción).

Status debe ser 200 y el body { init_point: "https://www.mercadopago.com/..." }.

Console del navegador:

Debe imprimirse [MP] respuesta create-preference: … con status: 200.

Si queda cargando:

Confirmá que no estás tirando un return antes de redirigir.

Confirmá que setLoading(false) está en finally.

Si el POST no aparece en Network, el onClick no se está ejecutando (ver onClick={handleContinue} y que el botón no esté disabled).

Prod (Vercel):

VITE_API_BASE seteado a tu dominio https://sukanec.vercel.app (sin slash final).

En los Logs de Vercel, al probar, deberías ver invocaciones de /api/mp/create-preference.