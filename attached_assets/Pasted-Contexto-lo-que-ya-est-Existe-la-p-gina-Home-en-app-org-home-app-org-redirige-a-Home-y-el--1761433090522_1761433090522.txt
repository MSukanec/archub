Contexto (lo que ya está)

Existe la página Home en /app/:org/home.

/app/:org redirige a Home y el logo/lanzador tienen ítem Inicio arriba.

Home ya tiene el layout (saludo, cards de accesos, proyectos activos, academia, comunidad).

Backend (DB) ya creado

En public.user_preferences agregamos:

home_checklist jsonb con default:

{"create_project": false, "create_contact": false, "create_movement": false}


home_banner_dismissed boolean default false

last_home_seen_at timestamptz default now()

Y hay RPCs para modificar estado:

-- Marcar un paso del checklist
create or replace function public.tick_home_checklist(p_key text, p_value boolean default true)
returns boolean
language sql
security definer
set search_path = public
as $$
  update public.user_preferences up
  set home_checklist = jsonb_set(
        coalesce(up.home_checklist, '{}'::jsonb),
        ARRAY[p_key],
        to_jsonb(p_value),
        true
      ),
      updated_at = now()
  where up.user_id = (select u.id from public.users u where u.auth_id = auth.uid() limit 1);
  select true;
$$;

-- Ocultar el banner
create or replace function public.dismiss_home_banner()
returns boolean
language sql
security definer
set search_path = public
as $$
  update public.user_preferences up
  set home_banner_dismissed = true,
      updated_at = now()
  where up.user_id = (select u.id from public.users u where u.auth_id = auth.uid() limit 1);
  select true;
$$;


Nota RLS: si user_preferences tiene RLS, asegúrense de permitir select/update de la propia fila. Si está “Unrestricted”, no hace falta.

Objetivo de esta tarea

Implementar en Home un banner de bienvenida con checklist de activación (3 pasos) y persistencia:

Mostrar banner solo si:

onboarding_completed === true

home_banner_dismissed === false

algún valor de home_checklist es false

Cada paso se marca como completado al finalizar la acción real (crear proyecto/contacto/movimiento) llamando a la RPC tick_home_checklist.

Botón “Ocultar este banner” llama a dismiss_home_banner.

Si los 3 pasos están true, el banner no se muestra más.

Qué hay que hacer (paso a paso)
1) Obtener user_preferences del usuario actual

Obtener user_id a partir de auth.uid() (o traerlo con un join si ya lo tienen).

Query:

const { data: prefs, error } = await supabase
  .from('user_preferences')
  .select('onboarding_completed, home_checklist, home_banner_dismissed')
  .eq('user_id', currentUserId)
  .single();


Guardar en estado local para renderizar Home.

2) Banner en Home (componente)

Crear componente HomeWelcomeBanner que reciba:

onboardingCompleted: boolean

homeChecklist: { create_project: boolean; create_contact: boolean; create_movement: boolean }

bannerDismissed: boolean

onDismiss: () => Promise<void>

Lógica de visibilidad en el padre (Home):
showBanner = prefs.onboarding_completed && !prefs.home_banner_dismissed && Object.values(prefs.home_checklist).some(v => !v)

Contenido del banner:

Título: ¡Bienvenido a Archub!

Texto: Completá estos pasos para comenzar:

3 ítems con checkbox/estado:

Crear primer proyecto

Crear primer contacto

Crear primer movimiento

Botón secundario: “Ver lección de 5 min” → link a Academia.

Botón “Ocultar este banner” → onDismiss().

3) Marcar pasos al finalizar acciones

Agregar las llamadas a la RPC en las pantallas donde ocurren las acciones:

Crear Proyecto (on success):

await supabase.rpc('tick_home_checklist', { p_key: 'create_project' });


Crear Contacto (on success):

await supabase.rpc('tick_home_checklist', { p_key: 'create_contact' });


Crear Movimiento (on success):

await supabase.rpc('tick_home_checklist', { p_key: 'create_movement' });


Después de cada RPC, refetch de user_preferences o actualizá el estado local del checklist para reflejar el check.

4) Dismiss del banner

En el botón “Ocultar este banner”:

await supabase.rpc('dismiss_home_banner');
// Refetch de user_preferences o setear bannerDismissed = true


Además, si los 3 flags del checklist están true, auto-ocultar el banner (no hace falta llamar a la RPC en ese caso, basta con que no cumpla la condición de visibilidad).

5) UI/UX

Mantener el look & feel del producto (cards, iconografía, verde Archub).

Indicar visualmente cada ítem del checklist como completado (check verde) o pendiente (círculo vacío).

Los botones “Crear…” deben navegar a las vistas existentes:

Crear proyecto → /app/:org/organizacion/proyectos/new (o lo que corresponda)

Crear contacto → ruta actual de creación de contactos

Crear movimiento → ruta actual de creación de movimientos

6) (Opcional) Telemetría mínima

Loguear evento cuando el usuario marca cada paso o hace dismiss del banner (si tienen una capa de analytics).

Criterios de aceptación (QA)

Usuario con onboarding_completed = true, home_banner_dismissed = false y todo home_checklist = false → ve el banner.

Crea un proyecto → vuelve a Home → el ítem “Crear primer proyecto” aparece tildado.

Crea un contacto y un movimiento → los otros dos ítems quedan tildados.

Con los 3 ítems en true, el banner ya no se muestra.

Presiona “Ocultar este banner” → home_banner_dismissed = true y el banner no vuelve a aparecer.

Si el usuario refresca la página, el estado del banner y los checks se mantienen (persistencia OK).