PROMPT PARA REPLIT — Checkout “one-page listo para pagar”

Quiero refactorizar mi página de checkout (Vite + React + TS + Tailwind + Zustand + Supabase v2) a un flujo de una sola página con estas reglas:

0) Contexto y endpoints existentes

Ya tengo Step 1 “Datos Básicos” funcionando (nombre, apellido opcional, email, país, teléfono opcional, “guardar en mi perfil”).

Endpoints a usar (no crearlos ahora, solo llamarlos):

POST /api/orders/create

POST /api/payments/mercadopago/create

POST /api/payments/paypal/create

POST /api/payments/bank/create (transferencia)

Los endpoints de pago devuelven URL de redirección (init_point MP / approve_link PayPal).

Si el order_id no existe aún, el CTA debe crear la order y luego iniciar el pago.

1) Store de checkout (Zustand)

Crear/actualizar src/stores/checkoutStore.ts:

import { create } from 'zustand';
import { persist } from 'zustand/middleware';

export type BuyerIdentity = {
  first_name: string;
  last_name?: string;
  email: string;
  country_id: string;      // uuid countries.id
  country_alpha2?: string; // p.ej. "AR"
  country_code?: string;   // p.ej. "+54" (solo para armar E.164)
  phone_e164?: string | null;
  save_to_profile?: boolean;
};

export type Consents = {
  accept_terms: boolean;
  accept_privacy: boolean;
  marketing_opt_in: boolean;
};

export type PaymentMethod = 'mercadopago' | 'paypal' | 'bank_transfer';

type CheckoutState = {
  buyer?: BuyerIdentity;
  consents: Consents;
  selectedPayment: PaymentMethod | null;
  orderId?: string;
  currencyShown: 'ARS' | 'USD'; // solo para UI del resumen
  setBuyer: (b: Partial<BuyerIdentity>) => void;
  setConsents: (c: Partial<Consents>) => void;
  setSelectedPayment: (p: PaymentMethod) => void;
  setOrderId: (id: string) => void;
  setCurrencyShown: (c: 'ARS'|'USD') => void;
  reset: () => void;
};

export const useCheckoutStore = create<CheckoutState>()(persist((set) => ({
  buyer: undefined,
  consents: { accept_terms: false, accept_privacy: false, marketing_opt_in: false },
  selectedPayment: null,
  orderId: undefined,
  currencyShown: 'USD',
  setBuyer: (b) => set((s) => ({ buyer: { ...s.buyer, ...b } as BuyerIdentity })),
  setConsents: (c) => set((s) => ({ consents: { ...s.consents, ...c } })),
  setSelectedPayment: (p) => set({ selectedPayment: p }),
  setOrderId: (id) => set({ orderId: id }),
  setCurrencyShown: (c) => set({ currencyShown: c }),
  reset: () => set({ buyer: undefined, consents: { accept_terms:false, accept_privacy:false, marketing_opt_in:false }, selectedPayment: null, orderId: undefined, currencyShown: 'USD' })
}), { name: 'checkout-state' }));

2) Utilidades de país y orden de métodos

Crear src/utils/paymentOrder.ts:

import type { PaymentMethod } from '@/stores/checkoutStore';

const MP_COUNTRIES = new Set(['AR','BR','CL','CO','MX','PE','UY','PY']); // ajustar si sumás otros

export function orderedMethods(alpha2?: string): PaymentMethod[] {
  const all: PaymentMethod[] = ['mercadopago','paypal','bank_transfer'];
  if (!alpha2) return all; // sin país aún, no reordenar
  const mpFirst = MP_COUNTRIES.has(alpha2);
  return mpFirst ? ['mercadopago','paypal','bank_transfer'] : ['paypal','mercadopago','bank_transfer'];
}

3) Componente “Métodos de pago”

Actualizar tu sección “Métodos de pago” para:

No ocultar ningún método.

Reordenar con orderedMethods(buyer.country_alpha2).

Al seleccionar un método:

setSelectedPayment(m)

Cambiar currencyShown: 'ARS' si m==='mercadopago', si no 'USD'.

Actualizar el resumen (solo UI).

4) Resumen / CTA

El botón principal “Continuar al pago” debe:

Deshabilitarse hasta que:

buyer tenga first_name + email + country_id válidos,

consents.accept_terms && consents.accept_privacy sean true,

selectedPayment no sea null.

Cambiar label según método:

MP → “Pagar con Mercado Pago”

PayPal → “Pagar con PayPal”

Transfer → “Enviar comprobante de transferencia”

5) Handler del CTA (handlePay)

Crear src/pages/checkout/handlePay.ts:

export async function handlePay({
  buyer,
  consents,
  selectedPayment,
  orderId,
  setOrderId
}: {
  buyer: import('@/stores/checkoutStore').BuyerIdentity;
  consents: import('@/stores/checkoutStore').Consents;
  selectedPayment: import('@/stores/checkoutStore').PaymentMethod;
  orderId?: string;
  setOrderId: (id: string)=>void;
}) {
  // 1) Crear order si no existe
  let currentOrderId = orderId;
  if (!currentOrderId) {
    const createRes = await fetch('/api/orders/create', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({
        // Ajustar con tus datos reales del curso actual:
        items: [{ type: 'course', id: /* course_id */, qty: 1 }],
        buyer_identity: buyer,
        consents,                // { accept_terms, accept_privacy, marketing_opt_in }
        // currencyPreferred: selectedPayment === 'mercadopago' ? 'ARS' : 'USD' // si tu backend lo usa
      })
    });
    const createJson = await createRes.json();
    if (!createRes.ok || !createJson?.order_id) throw new Error(createJson?.error || 'No se pudo crear la orden');
    currentOrderId = createJson.order_id;
    setOrderId(currentOrderId);
  }

  // 2) Iniciar pago según método
  if (selectedPayment === 'mercadopago') {
    const r = await fetch('/api/payments/mercadopago/create', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ order_id: currentOrderId })
    });
    const j = await r.json();
    if (!r.ok || !j?.init_point) throw new Error(j?.error || 'No se pudo iniciar Mercado Pago');
    window.location.href = j.init_point;
    return;
  }

  if (selectedPayment === 'paypal') {
    const r = await fetch('/api/payments/paypal/create', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ order_id: currentOrderId })
    });
    const j = await r.json();
    if (!r.ok || !j?.approve_link) throw new Error(j?.error || 'No se pudo iniciar PayPal');
    window.location.href = j.approve_link;
    return;
  }

  // bank_transfer
  const r = await fetch('/api/payments/bank/create', {
    method: 'POST',
    headers: { 'Content-Type':'application/json' },
    body: JSON.stringify({ order_id: currentOrderId })
  });
  const j = await r.json();
  if (!r.ok || !j?.payment_id) throw new Error(j?.error || 'No se pudo crear el pago por transferencia');
  // Mostrar modal/instrucciones o redirigir a una pantalla “Comprobante pendiente”
  // window.location.href = `/checkout/transfer/${j.payment_id}`; // si tenés ruta
}

6) Integración en tu página de Checkout

En tu página (donde ya tenés los inputs):

Al cambiar método, llamá setSelectedPayment.

Al cambiar país, además de country_id guardá country_alpha2 (venir de tu tabla; ya agregamos alpha_2) y country_code (si lo usás para teléfono).

El CTA llama a handlePay({...}) con los valores del store y maneja loading/errores (deshabilitar botón y mostrar toast).

7) Consents

Los checkboxes del bloque derecho:

“Acepto Términos y Condiciones y Políticas de Privacidad” → setConsents({ accept_terms:true, accept_privacy:true })

“Acepto recibir comunicaciones…” → setConsents({ marketing_opt_in: value }) (no bloquea el CTA).

Importante: en orders/create mandamos consents para snapshot legal.

8) Facturación (no bloquear)

Agregar un accordion cerrado “Necesito factura / Datos de facturación” (placeholder por ahora).

No bloquear el CTA. Si el usuario lo abre y completa, tu orders/create puede recibir billing_profile_id o datos en bruto (se implementará en el Paso 2).

9) Moneda mostrada

Si selectedPayment==='mercadopago' → mostrar ARS en el resumen.

Si PayPal → USD.

Esto solo afecta la UI; el precio efectivo lo calcula el backend al crear el pago (ya lo tenemos en tu arquitectura).

10) Accesibilidad y UX

Mantener todo en una sola ruta.

Scroll suave al primer error en el submit.

Autofocus al CTA cuando todo esté válido.

Enter = click CTA.

Criterios de aceptación

Se ven todos los métodos; solo cambia el orden por país.

El CTA cambia de texto según el método elegido y redirige al link del proveedor.

Si no existe order_id, lo crea antes de iniciar el pago.

Los consentimientos habilitan/deshabilitan el CTA correctamente.

El resumen refleja moneda acorde al método (ARS/ USD).

Nada de wizards ni rutas nuevas: una sola página.