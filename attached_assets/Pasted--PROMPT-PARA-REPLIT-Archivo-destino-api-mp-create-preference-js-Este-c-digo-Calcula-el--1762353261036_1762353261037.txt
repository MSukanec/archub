üßæ PROMPT PARA REPLIT

üìÑ Archivo destino: /api/mp/create_preference.js
üí° Este c√≥digo:

Calcula el precio real del curso en backend

Aplica el cup√≥n solo si es v√°lido

Crea la preferencia con el monto correcto

Soporta ARS/USD seg√∫n tu configuraci√≥n

üîß Prompt
// --- /api/mp/create_preference.js ---
// Crea una preferencia de pago en Mercado Pago con cup√≥n opcional
// Usa Supabase como fuente de precios oficiales (sin confiar en el front)

import mercadopago from "mercadopago";
import { createClient } from "@supabase/supabase-js";

const cors = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
  "Access-Control-Allow-Methods": "POST, OPTIONS",
  "Access-Control-Max-Age": "86400",
};

export default async function handler(req, res) {
  if (req.method === "OPTIONS") return res.status(200).json("ok");

  try {
    const { user_id, course_slug, coupon_code = null } = req.body || {};

    if (!course_slug) {
      return res.status(400).json({ error: "Falta course_slug" });
    }

    // --- Supabase ---
    const supabase = createClient(
      process.env.SUPABASE_URL,
      process.env.SUPABASE_SERVICE_ROLE_KEY
    );

    // --- Buscar precio base ---
    const { data: course, error: e1 } = await supabase
      .from("course_prices")
      .select("course_id, provider, currency, price")
      .eq("provider", "mercadopago")
      .eq("currency", "ARS")
      .eq("course_id", course_slug)
      .single();

    if (e1 || !course) {
      console.error("Error buscando precio base:", e1);
      return res.status(400).json({ error: "No se encontr√≥ el curso o precio base." });
    }

    let final_price = course.price;
    let discount_applied = null;

    // --- Buscar y aplicar cup√≥n si existe ---
    if (coupon_code) {
      const { data: coupon } = await supabase
        .from("coupons")
        .select("code, discount_percent, is_active, expires_at")
        .eq("code", coupon_code)
        .maybeSingle();

      if (coupon && coupon.is_active) {
        const now = new Date();
        const exp = coupon.expires_at ? new Date(coupon.expires_at) : null;

        if (!exp || exp > now) {
          const discount = (coupon.discount_percent / 100) * final_price;
          final_price = Math.max(1, Math.round(final_price - discount)); // evitar cero
          discount_applied = coupon.discount_percent;
        }
      }
    }

    // --- Configurar MP ---
    mercadopago.configure({
      access_token: process.env.MP_ACCESS_TOKEN,
    });

    // --- Crear preferencia ---
    const preference = await mercadopago.preferences.create({
      items: [
        {
          title: "Curso Archub",
          quantity: 1,
          currency_id: "ARS",
          unit_price: final_price,
        },
      ],
      back_urls: {
        success: `${process.env.VITE_API_BASE}/success`,
        failure: `${process.env.VITE_API_BASE}/failure`,
        pending: `${process.env.VITE_API_BASE}/pending`,
      },
      auto_return: "approved",
      metadata: {
        user_id,
        course_slug,
        coupon_code,
        discount_applied,
      },
    });

    return res.status(200).json({
      success: true,
      init_point: preference.body.init_point,
      final_price,
      discount_applied,
    });
  } catch (error) {
    console.error("‚ùå Error creando preferencia MP:", error);
    return res.status(500).json({ error: error.message });
  }
}

export const config = {
  api: {
    bodyParser: true,
  },
  runtime: "edge",
};

‚úÖ Verificaci√≥n r√°pida tras pegarlo

Guard√° el archivo en Replit.

Asegurate de tener las variables de entorno actualizadas:

MP_ACCESS_TOKEN (producci√≥n o test)

SUPABASE_URL

SUPABASE_SERVICE_ROLE_KEY

VITE_API_BASE=https://sukanec.vercel.app

Volv√© a probar una compra:

Sin cup√≥n ‚Üí debe funcionar igual que antes.

Con cup√≥n ‚Üí ahora debe completarse correctamente (con precio ajustado).