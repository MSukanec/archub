PROMPT para Replit (copialo y pegalo tal cual)

Quiero que hagas estas modificaciones exactas en mi proyecto:

1) Crear helper src/utils/apiBase.ts

Crea el archivo src/utils/apiBase.ts con este contenido:

// src/utils/apiBase.ts
export function getApiBase(): string {
  // 1) Preferir VITE_API_BASE si existe (prod o preview en Vercel)
  const fromEnv =
    (typeof import.meta !== "undefined" &&
      import.meta.env &&
      import.meta.env.VITE_API_BASE) ||
    "";

  if (fromEnv && typeof fromEnv === "string" && fromEnv.trim() !== "") {
    return fromEnv.trim().replace(/\/+$/, "");
  }

  // 2) Fallback local (Replit preview / dev server)
  if (typeof window !== "undefined" && window.location?.origin) {
    return window.location.origin.replace(/\/+$/, "");
  }

  return ""; // último recurso (no debería pasar)
}

2) Editar src/components/PaymentMethodModal.tsx

Abrí src/components/PaymentMethodModal.tsx y hacé estos cambios:

a) Imports: agregá

import { getApiBase } from "@/utils/apiBase";


b) Asegurate de tener un estado de loading y errores en el modal. Si ya existen, usalos; si no, agregalos:

const [submitting, setSubmitting] = useState(false);
const [errorMsg, setErrorMsg] = useState<string | null>(null);


c) Función para crear preferencia de Mercado Pago. Agregá esta función completa (no la mezcles con otras; esta reemplaza cualquier lógica vieja que llamaba a Supabase Edge Functions):

async function handleMercadoPagoConfirm() {
  try {
    setErrorMsg(null);
    setSubmitting(true);

    // Datos necesarios del curso/usuario
    // Ajusta estos nombres si en tu modal se llaman distinto:
    const userId = currentUser?.id;            // <-- tu fuente real de user.id
    const courseSlug = selectedCourse?.slug;   // <-- tu fuente real de slug de curso
    const months = selectedMonths ?? null;     // <-- si manejás duración; sino deja null
    const currency = "ARS";

    if (!userId || !courseSlug) {
      setSubmitting(false);
      setErrorMsg("Faltan datos de usuario o curso.");
      return;
    }

    const API_BASE = getApiBase();
    const url = `${API_BASE}/api/mp/create-preference`;

    // payload al backend
    const body = {
      user_id: userId,
      course_slug: courseSlug,
      currency,
      months, // puede ser null si no usás suscripción
    };

    const resp = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    });

    const data = await resp.json().catch(() => ({} as any));

    if (!resp.ok || !data?.init_point) {
      console.error("MP create-preference error:", data);
      setSubmitting(false);
      setErrorMsg(
        data?.error
          ? `No se pudo crear la preferencia: ${String(data.error)}`
          : "No se pudo crear la preferencia de pago."
      );
      return;
    }

    // Redirección a MP
    window.location.href = data.init_point;
  } catch (e: any) {
    console.error("MP create-preference fatal:", e);
    setSubmitting(false);
    setErrorMsg("Ocurrió un error al iniciar el pago.");
  }
}


d) Wirear el botón “Continuar” cuando está seleccionada la opción Mercado Pago.
Localizá la acción del botón principal (el que muestra “Continuar”). En el handler (ej. onConfirm o similar) meté esta lógica:

async function onConfirm() {
  // ejemplo de cómo decidís según método
  if (selectedMethod === "mercadopago_ars") {
    await handleMercadoPagoConfirm();
    return;
  }

  if (selectedMethod === "paypal_usd") {
    // dejá tu flujo actual de PayPal (ya lo tenés funcionando)
    await handlePayPalConfirm(); // si ya existe
    return;
  }

  if (selectedMethod === "bank_transfer") {
    await handleBankTransferConfirm?.(); // si existe
    return;
  }

  // si no hay nada seleccionado
  setErrorMsg("Seleccioná un método de pago.");
}


e) Botón y UI de loading/errores
En el botón “Continuar”, asegurate de:

Desactivarlo cuando submitting === true.

Mostrar el label “Cargando…” cuando submitting === true.

Ejemplo:

<Button
  disabled={submitting}
  onClick={onConfirm}
>
  {submitting ? "Cargando..." : "Continuar"}
</Button>


Y bajo el botón (o en el header del modal), mostrár el error si existe:

{errorMsg && (
  <div className="mt-2 text-sm text-red-500">
    {errorMsg}
  </div>
)}


f) Eliminar lógicas viejas de Supabase Edge Functions
Si el modal todavía llama a supabase.functions.invoke("create_mp_preference", …) o a cualquier URL como /functions/v1/..., reemplazalo por la función handleMercadoPagoConfirm() que llama a ${API_BASE}/api/mp/create-preference. No deben quedar restos de la ruta vieja.

3) Validación rápida

Guardá y corré el preview.

Abrí el modal de compra, dejá Mercado Pago (ARS) seleccionado y tocá Continuar.

En la pestaña Network de DevTools, deberías ver un POST a:

En preview (Replit): http(s)://<tu preview origin>/api/mp/create-preference

En producción (Vercel): https://sukanec.vercel.app/api/mp/create-preference

La respuesta debe traer { init_point: "https://www.mercadopago.com/..." } y el navegador debe redirigir a Mercado Pago automáticamente.

Si hay error:

el botón deja de estar en “Cargando…”

aparece el mensaje de error errorMsg en el modal.

Notas rápidas (por si Replit pregunta algo)

No uses Supabase Edge Functions para esta parte. Todo va contra las serverless /api del proyecto.

getApiBase() usa VITE_API_BASE si existe; si no, cae al window.location.origin. Ya seteé VITE_API_BASE en Replit y Vercel a https://sukanec.vercel.app, así que en producción apuntará allí.

PayPal ya funciona; no lo toques. Solo asegurate que su handler quede como está (o usar patrón similar si querés unificar).