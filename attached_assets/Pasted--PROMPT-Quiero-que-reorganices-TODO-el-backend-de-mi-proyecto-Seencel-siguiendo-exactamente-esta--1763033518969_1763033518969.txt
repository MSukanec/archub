ğŸŸ¦ PROMPT

Quiero que reorganices TODO el backend de mi proyecto Seencel siguiendo exactamente esta arquitectura profesional:

ğŸ”¥ 1. OBJETIVO GENERAL

Unificar backend, eliminar duplicadores, limpiar rutas, normalizar imports y asegurar que tanto Express (desarrollo) como Vercel serverless (producciÃ³n) usen LA MISMA LÃ“GICA.

ğŸ”¥ 2. ESTRUCTURA FINAL QUE DEBE QUEDAR
ğŸ“ /api/ (Vercel serverless)

Cada archivo dentro de /api/*.ts es un endpoint serverless.

Todos estos endpoints deben ser wrappers que llaman a lÃ³gica compartida.

NO colocar lÃ³gica pesada dentro de ellos.

ğŸ“ /api/_lib/handlers/

Crear esta carpeta si no existe.

Toda la lÃ³gica de negocio debe ir acÃ¡:

organization-members

projects

contacts

payments (PayPal y MercadoPago)

tasks

movements

design phases

everything else

Estos handlers deben ser framework-agnostic, es decir:

No deben depender de Express

No deben depender de Vercel

Solo deben recibir parÃ¡metros (body, user, orgId)

Solo deben retornar objetos planos { success, data, error }

ğŸ“ /server/routes.ts (Express para Replit)

NO debe contener NINGUNA lÃ³gica de negocio.

SOLO deben ser wrappers como:

app.post("/api/projects/create", async (req, res) => {
  const result = await handleCreateProject(req.body, supabaseAdmin);
  return res.json(result);
});


Cada ruta debe llamar a su handler correspondiente en /api/_lib/handlers/.

No debe haber endpoints que existan EN EXPRESS y NO existan en /api.

ğŸ”¥ 3. QUÃ‰ COSAS HAY QUE ELIMINAR

Eliminar o migrar:

âŒ LÃ³gica duplicada en server/routes.ts

Todo lo que tenga lÃ³gica debe ser movido a handlers.

âŒ Archivos viejos en /api/lib o /lib

Migrar todo a /api/_lib/.

âŒ Consultas directas en React usando service_role

NingÃºn archivo frontend debe usar serviceRole o supabaseAdmin.

âŒ API legacy en formato Next.js (POST(), GET())

NingÃºn archivo /api/*.ts debe tener sintaxis Next.js.

ğŸ”¥ 4. FORMATO OBLIGATORIO PARA ENDPOINTS SERVERLESS

Cada archivo /api/*.ts debe seguir exactamente este formato:

import type { VercelRequest, VercelResponse } from "@vercel/node";
import { handleXYZ } from "./_lib/handlers/xyz";
import { supabaseAdmin } from "./_lib/supabase-admin"; // si lo necesita

export default async function handler(req: VercelRequest, res: VercelResponse) {
  if (req.method !== "POST") {
    return res.status(405).json({ error: "Method Not Allowed" });
  }

  const result = await handleXYZ(req.body);
  return res.status(result.status || 200).json(result);
}


No debe usar:

export async function POST

NextResponse

Tipos Next.js

ğŸ”¥ 5. FORMATO OBLIGATORIO PARA HANDLERS

Todos los handlers deben seguir este patrÃ³n:

export async function handleCreateProject(params, supabase) {
  try {
    // lÃ³gica pura + validaciones
    // supabase queries
    return { success: true, data };
  } catch (err) {
    return { success: false, error: err.message };
  }
}

ğŸ”¥ 6. IMPORTS
En /api/*.ts:

Usar:

import { handleXYZ } from "./_lib/handlers/xyz.js";

En server/routes.ts:

Usar:

import { handleXYZ } from "../api/_lib/handlers/xyz.js";

En handlers:

Imports internos siempre con .js al final.

ğŸ”¥ 7. WEBHOOKS

Todos los webhooks (PayPal, MercadoPago) deben:

Vivir bajo /api/payments/...

Usar exclusvamente supabaseAdmin

Ser serverless, no Express

ğŸ”¥ 8. SERVICE ROLE

Solo permitir service role en:

Webhooks

Operaciones automÃ¡ticas

Migraciones o mantenimiento

Eliminar serviceRole del frontend.

ğŸ”¥ 9. RUTAS DEV VS PROD

Express (Replit) debe imitar EXACTAMENTE las rutas serverless.

Si existe /api/contacts/create en serverless â†’ debe existir la misma ruta en Express.

Si no existe en serverless â†’ eliminar de Express.

ğŸ”¥ 10. TAREAS

Necesito que hagas todo esto:

âœ… 1. Reorganizar archivos en carpetas correctas
âœ… 2. Actualizar todos los imports
âœ… 3. Migrar toda lÃ³gica a /api/_lib/handlers/
âœ… 4. Simplificar /server/routes.ts
âœ… 5. Eliminar duplicados
âœ… 6. Validar que Express y Vercel usen la misma API
âœ… 7. Asegurar que todos los endpoints compilen
âœ… 8. Asegurar que todo estÃ© escrito en TypeScript vÃ¡lido
âœ… 9. Asegurar que Vercel transpile todo sin problemas
âœ… 10. Probar mÃ­nimamente desde consola las rutas principales

Al final, dejame un resumen de:

quÃ© archivos moviste

quÃ© endpoints quedaron

quÃ© endpoints eliminaste

quÃ© handlers creaste

quÃ© lÃ³gica fue unificada

quÃ© lÃ³gica quedÃ³ obsoleta