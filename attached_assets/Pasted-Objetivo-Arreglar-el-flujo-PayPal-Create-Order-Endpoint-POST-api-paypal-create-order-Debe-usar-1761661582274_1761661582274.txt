Objetivo

Arreglar el flujo PayPal Create Order:

Endpoint: POST /api/paypal/create-order

Debe usar las variables de entorno que ya tengo en Vercel (Preview):

PAYPAL_CLIENT_ID

PAYPAL_CLIENT_SECRET

PAYPAL_ENV con valores sandbox o live

PAYPAL_BASE_URL (opcional). Si no existe, derivar con PAYPAL_ENV:

sandbox → https://api-m.sandbox.paypal.com

live → https://api-m.paypal.com

Runtime Node (NO Edge) para poder usar Buffer.

CORS abierto igual que mis otras functions.

Siempre responder JSON (también en los errores) con Content-Type: application/json, así el front no hace res.json() sobre HTML.

Loguear errores con console.error (sirve para ver en Vercel → Functions → Logs).

1) Crear/reescribir /api/paypal/create-order.ts (Node runtime)

Implementá este handler exacto (ajustá sólo si hace falta importar tipos):

// /api/paypal/create-order.ts  (Node runtime, NO EDGE)
export default async function handler(req: any, res: any) {
  const cors = {
    "Access-Control-Allow-Origin": "*",
    "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
    "Access-Control-Allow-Methods": "POST, OPTIONS",
  };

  if (req.method === "OPTIONS") {
    return res.status(200).set(cors).send("ok");
  }
  if (req.method !== "POST") {
    return res.status(405).set(cors).json({ ok: false, error: "Method not allowed" });
  }

  try {
    // Body mínimo: { order_id, amountUsd, description }
    // Si no me mandan amount/description desde el front, poné defaults temporales.
    const { order_id, amountUsd, description } = req.body ?? {};
    if (!order_id) throw new Error("Falta 'order_id'");

    const cid = process.env.PAYPAL_CLIENT_ID;
    const csec = process.env.PAYPAL_CLIENT_SECRET;
    const env = (process.env.PAYPAL_ENV || "sandbox").toLowerCase();
    const base =
      process.env.PAYPAL_BASE_URL ||
      (env === "live" ? "https://api-m.paypal.com" : "https://api-m.sandbox.paypal.com");

    if (!cid || !csec) throw new Error("Faltan PAYPAL_CLIENT_ID o PAYPAL_CLIENT_SECRET");

    // 1) OAuth
    const auth = Buffer.from(`${cid}:${csec}`).toString("base64");
    const tokenResp = await fetch(`${base}/v1/oauth2/token`, {
      method: "POST",
      headers: {
        Authorization: `Basic ${auth}`,
        "Content-Type": "application/x-www-form-urlencoded",
      },
      body: "grant_type=client_credentials",
    });

    const tokenText = await tokenResp.text();
    if (!tokenResp.ok) {
      // PayPal devuelve JSON, pero si por algún motivo no lo es, igual lo registramos
      console.error("PayPal OAuth error:", tokenResp.status, tokenText);
      return res.status(500).set(cors).json({
        ok: false,
        error: `OAuth PayPal falló: ${tokenResp.status}`,
        details: tokenText,
      });
    }
    const tokenJson = JSON.parse(tokenText);
    const access_token = tokenJson.access_token;
    if (!access_token) throw new Error("No se obtuvo 'access_token' de PayPal");

    // 2) Create Order
    const value = typeof amountUsd === "number" ? amountUsd.toFixed(2) : "169.00"; // default temporal
    const desc = description || `Order ${order_id}`;

    const createResp = await fetch(`${base}/v2/checkout/orders`, {
      method: "POST",
      headers: {
        Authorization: `Bearer ${access_token}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        intent: "CAPTURE",
        purchase_units: [
          {
            amount: { currency_code: "USD", value },
            description: desc,
          },
        ],
        application_context: {
          brand_name: "Archub",
          user_action: "PAY_NOW",
        },
      }),
    });

    const createText = await createResp.text();
    // PayPal responde JSON; si no, igual parseamos defensivo
    let createJson: any;
    try {
      createJson = JSON.parse(createText);
    } catch {
      createJson = { raw: createText };
    }

    if (!createResp.ok) {
      console.error("PayPal Create Order error:", createResp.status, createJson);
      return res
        .status(500)
        .set(cors)
        .json({ ok: false, error: `CreateOrder falló: ${createResp.status}`, details: createJson });
    }

    return res.status(200).set(cors).json({ ok: true, paypal_order: createJson });
  } catch (e: any) {
    console.error("create-order ERROR:", e);
    return res
      .status(500)
      .set({ "Content-Type": "application/json", ...cors })
      .send(JSON.stringify({ ok: false, error: e?.message ?? "Unknown error" }));
  }
}

2) Ajustar el fetch del front para tolerar errores no-200 sin romper

Buscá el lugar donde llamo a /api/paypal/create-order (el botón “Pagar con PayPal” en mi modal/página) y reemplazá la llamada por este patrón robusto:

async function createPaypalOrder(order_id: string, amountUsd?: number, description?: string) {
  const res = await fetch("/api/paypal/create-order", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ order_id, amountUsd, description }),
  });

  const text = await res.text();
  let payload: any;
  try {
    payload = JSON.parse(text);
  } catch {
    payload = { ok: false, error: text };
  }

  if (!res.ok || !payload?.ok) {
    throw new Error(payload?.error || `HTTP ${res.status}`);
  }

  return payload.paypal_order; // objeto de PayPal con los links, id, etc.
}

3) Confirmaciones y pruebas

Asegurate de que el archivo esté en /api/paypal/create-order.ts (esa es la ruta en Vercel).

No declares export const config = { runtime: "edge" } en este archivo (queremos Node).

Leer env vars exactas: PAYPAL_CLIENT_ID, PAYPAL_CLIENT_SECRET, PAYPAL_ENV, PAYPAL_BASE_URL (opcional).

Commit y deploy. Yo probaré en la URL de Preview (porque las env están cargadas en Preview).

Si hay error 500, quiero que me indiques cómo abrir Vercel → Functions → Logs y busques la última invocación de /api/paypal/create-order, para ver el mensaje exacto. Asegurate de que cualquier error del catch o de PayPal se loguee y la respuesta sea JSON.

4) (Opcional, si lo ves en el proyecto)

Si existe alguna llamada previa que asumía PAYPAL_MODE o usaba Edge runtime, reemplazala por este file y estos nombres de env.

NO toques Mercado Pago.

Al terminar, mostrame:

El diff de /api/paypal/create-order.ts.

El snippet actualizado del fetch del front.

Un breve checklist de verificación (envs leídas, runtime Node, response JSON).