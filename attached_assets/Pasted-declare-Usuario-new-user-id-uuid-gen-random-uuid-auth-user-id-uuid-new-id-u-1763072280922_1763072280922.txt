declare
  -- Usuario
  new_user_id uuid := gen_random_uuid();
  auth_user_id uuid := new.id;
  user_full_name text := coalesce(new.raw_user_meta_data->>'full_name', null);
  user_email text := lower(new.email);
  user_avatar text := coalesce(new.raw_user_meta_data->>'avatar_url', '');
  provider text := lower(coalesce(new.raw_user_meta_data->>'provider', 'email'));

  -- Fuente de avatar (ENUM en public)
  avatar_src public.avatar_source_t := 'email'::public.avatar_source_t;

  -- Plan / roles / org / etc.
  plan_free_id uuid := '015d8a97-6b6e-4aec-87df-5d1e6b0e4ed2';
  archub_user_role_id uuid := 'e6cc68d2-fc28-421b-8bd3-303326ef91b8';
  org_id uuid := gen_random_uuid();
  org_name text := 'Organizaci√≥n de ' || coalesce(user_full_name, 'Usuario');
  now_timestamp timestamptz := now();
  org_member_id uuid := gen_random_uuid();
  admin_role_id uuid := '81be9c24-1e85-4f48-a131-2c618e0d1888';
  default_currency_id uuid := '58c50aa7-b8b1-4035-b509-58028dd0e33f';
  default_wallet_id uuid := '2658c575-0fa8-4cf6-85d7-6430ded7e188';
  currency_link_id uuid := gen_random_uuid();
  wallet_link_id uuid := gen_random_uuid();
  default_pdf_template_id uuid := 'b6266a04-9b03-4f3a-af2d-f6ee6d0a948b';
begin
  -- Resolver fuente del avatar sin generar URL nueva
  if provider = 'google' then
    avatar_src := 'google';
  elsif provider = 'discord' then
    avatar_src := 'discord';
  else
    avatar_src := 'email';
  end if;

  -- Paso 1: users
  insert into public.users (id, auth_id, email, full_name, avatar_url, avatar_source, role_id)
  values (new_user_id, auth_user_id, user_email, user_full_name, user_avatar, avatar_src, archub_user_role_id);

  -- Paso 2: user_data
  insert into public.user_data (id, user_id, country, birthdate, phone_e164, created_at)
  values (gen_random_uuid(), new_user_id, null, null, null, now_timestamp);

  -- Paso 3: organizations
  insert into public.organizations (id, name, created_by, created_at, updated_at, is_active, plan_id)
  values (org_id, org_name, new_user_id, now_timestamp, now_timestamp, true, plan_free_id);

  -- Paso 4: organization_data
  insert into public.organization_data (organization_id)
  values (org_id);

  -- Paso 5: organization_members
  insert into public.organization_members
    (id, user_id, organization_id, role_id, is_active, created_at, joined_at, last_active_at)
  values
    (org_member_id, new_user_id, org_id, admin_role_id, true, now_timestamp, now_timestamp, now_timestamp);

  -- Paso 6: organization_currencies
  insert into public.organization_currencies
    (id, organization_id, currency_id, is_active, is_default, created_at)
  values
    (currency_link_id, org_id, default_currency_id, true, true, now_timestamp);

  -- Paso 7: organization_wallets
  insert into public.organization_wallets
    (id, organization_id, wallet_id, is_active, is_default, created_at)
  values
    (wallet_link_id, org_id, default_wallet_id, true, true, now_timestamp);

  -- Paso 8: organization_preferences
  insert into public.organization_preferences
    (organization_id, default_currency_id, default_wallet_id, default_pdf_template_id, use_currency_exchange, created_at, updated_at)
  values
    (org_id, default_currency_id, default_wallet_id, default_pdf_template_id, false, now_timestamp, now_timestamp);

  -- Paso 9: user_preferences
  insert into public.user_preferences
    (id, user_id, last_organization_id, theme, onboarding_completed, sidebar_docked, layout, created_at)
  values
    (gen_random_uuid(), new_user_id, org_id, 'light', false, false, 'experimental', now_timestamp);

  -- Paso 10: user_organization_preferences
  insert into public.user_organization_preferences
    (id, user_id, organization_id, last_project_id, created_at, updated_at)
  values
    (gen_random_uuid(), new_user_id, org_id, null, now_timestamp, now_timestamp);

  -- Paso 11: linked_accounts
  if not exists (
    select 1 from public.linked_accounts
    where auth_id = auth_user_id and provider_source = provider
  ) then
    insert into public.linked_accounts
      (id, user_id, auth_id, provider_source, created_at)
    values
      (gen_random_uuid(), new_user_id, auth_user_id, provider, now_timestamp);
  end if;

  -- ‚úÖ Paso 12: IA - inicializar l√≠mites de uso
  insert into public.ia_user_usage_limits (
    user_id,
    plan,
    daily_limit,
    prompts_used_today,
    last_prompt_at,
    last_reset_at
  )
  values (
    new_user_id,
    'free',          -- plan por defecto
    3,               -- 3 prompts diarios
    0,               -- a√∫n no us√≥ ninguno
    null,            -- sin √∫ltimo prompt
    current_date     -- fecha de inicio de control
  );

  return new;

exception when others then
  raise exception 'üí• ERROR en handle_new_user: %', sqlerrm;
end;