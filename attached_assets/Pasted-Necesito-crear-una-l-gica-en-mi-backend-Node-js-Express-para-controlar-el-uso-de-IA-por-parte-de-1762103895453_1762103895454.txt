Necesito crear una lÃ³gica en mi backend (Node.js + Express) para controlar el uso de IA por parte de los usuarios autenticados.

ğŸ§  CONTEXTO:
- Estoy usando Supabase como base de datos.
- Tengo una tabla `ia_user_usage_limits` con estos campos:

```sql
user_id (uuid, PK, FK a users)
daily_limit_uses (int)
monthly_limit_uses (int)
daily_limit_tokens (int)
monthly_limit_tokens (int)
created_at
updated_at
Quiero que la IA salude al usuario 3 veces por dÃ­a como mÃ¡ximo (maÃ±ana, tarde y noche). Por eso:

Cada saludo cuenta como 1 uso y ~500 tokens.

El lÃ­mite por dÃ­a es 3 usos / 1500 tokens.

El lÃ­mite mensual es 90 usos / 45000 tokens.

ğŸ¯ OBJETIVO:
Crear una funciÃ³n en /api/ia/greeting.ts que:

Reciba el auth_id del usuario desde el header (JWT de Supabase).

Verifique si el usuario estÃ¡ autorizado (token vÃ¡lido).

Busque en Supabase su user_id a partir del auth_id.

Consulte la tabla ia_user_usage_limits para ver si aÃºn no superÃ³ los lÃ­mites diarios o mensuales.

Si el dÃ­a cambiÃ³ desde el Ãºltimo updated_at, reinicie los contadores diarios (0).

Si todavÃ­a no superÃ³ los lÃ­mites:

Devuelva un saludo personalizado (Buenos dÃ­as, Buenas tardes, Buenas noches) segÃºn la hora del sistema.

Inserte un nuevo mensaje en una tabla ia_user_messages (ya creada), guardando user_id, message, tokens_used, created_at.

Incremente los contadores en ia_user_usage_limits (usos diarios y mensuales, tokens diarios y mensuales).

Si ya superÃ³ el lÃ­mite diario o mensual:

Devuelva un mensaje de error (LÃ­mite alcanzado, Upgrade to PRO, etc.).

Que use Supabase JS v2 (client desde @supabase/supabase-js) y que funcione bien como endpoint serverless en /api.

ğŸ‘¨â€ğŸ”§ Detalles tÃ©cnicos:

El sistema de autenticaciÃ³n ya funciona con Supabase Auth, asÃ­ que puedo obtener auth_id del JWT.

Estoy usando Supabase en modo serverless, asÃ­ que necesito una funciÃ³n handler(req, res) exportada en /api/ia/greeting.ts.

Â¡Generame todo ese archivo por favor! Con tipado si podÃ©s (TypeScript).

yaml
Copiar cÃ³digo

---

### ğŸ”„ Â¿Y despuÃ©s?

Cuando tengas este endpoint generado (`/api/ia/greeting.ts`), el **frontend** simplemente puede hacer:

```ts
const res = await fetch('/api/ia/greeting', {
  method: 'POST',
  headers: {
    Authorization: `Bearer ${accessToken}`, // lo provee Supabase
  },
});
const data = await res.json();
Y asÃ­ podÃ©s mostrar el saludo si fue exitoso, o el mensaje de lÃ­mite alcanzado.