PROMPT PARA REPLIT (implementar sin romper nada)

Usa tus endpoints ya existentes como guía. Crea tres endpoints simples y un pequeño componente en el checkout.

Objetivo: Implementar Transferencia con comprobante y revisión.

1) Front (Checkout)

En el método Transferencia, al hacer clic en “Ver datos bancarios / Continuar”, ejecutar:

POST /api/bank-transfer/create con { amount, currency, user_id, order_id }
→ devuelve btp_id (id del pago por transferencia).

Mostrar datos bancarios y un uploader (aceptar .pdf, .jpg, .png).

Al subir archivo: POST /api/bank-transfer/upload con { btp_id, file }
→ actualiza receipt_url.

Mostrar estado PENDIENTE DE REVISIÓN y un resumen.

En el Dashboard del usuario, agregar una mini sección “Mis pagos por transferencia” con estado y si pueden reemplazar el comprobante mientras status='pending'.

2) Endpoints

/api/bank-transfer/create

Body: { order_id, amount, currency } (user_id lo saca del JWT).

Acciones:

Inserta en bank_transfer_payments con status='pending'.

Devuelve { btp_id }.

/api/bank-transfer/upload

Body: { btp_id, file }.

Acciones:

Sube el archivo a bank-transfer-receipts/<btp_id>.<ext>.

Guarda receipt_url en la fila (si status='pending').

Devuelve { ok: true }.

/api/bank-transfer/review (ADMIN)

Body: { btp_id, action: 'approve' | 'reject', reason? }.

Acciones:

Si approve:

update bank_transfer_payments set status='approved', reviewed_by=<admin_id>, reviewed_at=now().

Inserta en payments_log (o tu tabla equivalente) con provider=bank_transfer, status=approved, order_id, amount, currency.

Concede acceso: si es curso → upsert en course_enrollments y set started_at=now(); si es plan → activar plan de la organización/usuario (usa tu función/SQL existente).

Si reject:

status='rejected', review_reason.

(Opcional) Enviar email de notificación.

Importante: No inventes nombres; si ya tenés /api/payments_log o funciones tipo handle_grant_enrollment, reutilizalas. El endpoint solo orquesta.

3) QA esperado

Usuario ve su pago y puede reemplazar comprobante mientras esté pending.

Admin aprueba/rechaza y queda todo en historial (sin deletes).

Al aprobar, se habilita el acceso igual que con PayPal/MP.

Todo queda auditado en payments_log.

¿Por qué así?

Auditable: nunca se borra, queda historial + recibo.

Escalable: mañana agregás “Depósito en efectivo” y es el mismo flujo.

Consistente: se integra a tu payments_log y a tu mecanismo de otorgar acceso.