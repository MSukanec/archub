Quiero implementar un sistema completo para subir y gestionar documentos en mi aplicaciÃ³n.

ğŸ§© Tabla y contexto
Ya tengo una tabla llamada design_documents que incluye los siguientes campos:

id (uuid)

name (text)

description (text)

folder (text)

status (text)

visibility (text)

project_id (uuid)

organization_id (uuid)

design_phase_id (uuid)

created_by (uuid)

file_path (text)

file_url (text)

file_type (text)

file_size (int8)

version_number (int4)

created_at (timestamp)

ğŸ¯ Objetivo
Quiero que al subir un nuevo documento, se aplique la siguiente lÃ³gica:

Si ya existe un documento con el mismo nombre, carpeta, proyecto y fase de diseÃ±o, entonces se debe crear una nueva versiÃ³n de ese documento (aumentando el version_number).

Si no existe ningÃºn documento previo con esos criterios, debe insertarse con version_number = 1.

ğŸ§  Instrucciones
ğŸ”¹ 1. En la pÃ¡gina de /design/documentation
Mostrar los documentos agrupados por nombre, carpeta, proyecto y fase.

De cada grupo, mostrar solo el de mayor version_number (la versiÃ³n mÃ¡s reciente).

Al hacer clic en un documento, permitir ver las versiones anteriores.

Para obtener la Ãºltima versiÃ³n por grupo:

sql
Copiar
Editar
SELECT DISTINCT ON (name, folder, project_id, design_phase_id) *
FROM design_documents
ORDER BY name, folder, project_id, design_phase_id, version_number DESC;
ğŸ”¹ 2. En el modal NewDesignDocumentModal.tsx
ğŸ“¤ Al hacer clic en "Guardar":
Buscar si ya existe un documento con ese mismo nombre, carpeta, proyecto y fase:

ts
Copiar
Editar
const { data: existingDocs } = await supabase
  .from("design_documents")
  .select("version_number")
  .eq("project_id", projectId)
  .eq("folder", folder)
  .eq("name", name)
  .eq("design_phase_id", designPhaseId); // si aplica
Calcular el version_number:

ts
Copiar
Editar
const versionNumber = existingDocs?.length
  ? Math.max(...existingDocs.map((d) => d.version_number ?? 1)) + 1
  : 1;
Subir el archivo al bucket design-documents.

Insertar el documento en la tabla con el nuevo version_number, incluyendo tambiÃ©n file_path, file_url, file_size, file_type, etc.

ğŸ§¹ Extras visuales
Mostrar el version_number como v1, v2, etc. en la card.

Incluir una pequeÃ±a opciÃ³n de â€œVer historial de versionesâ€ que despliegue la lista de versiones previas si existen.

âœ… Consideraciones
Ya estÃ¡n creadas las RLS necesarias.

El bucket design-documents tambiÃ©n tiene sus polÃ­ticas listas.

Usamos created_by como clave forÃ¡nea a la tabla users.id.

